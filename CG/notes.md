# 课堂笔记

## 第 1 章  计算机图形学入门

+ 计算机图形硬件

  + 输出设备
  + 输入设备
  + 处理设备

+ 图形适配卡：显卡

  图形处理芯片：GPU

  通用图形处理器：GPGPU

+ fragment ~ pixel 【这两者真的是同一个概念吗】

+ 图形 API

  + OpenGL - 跨平台
  + DirectX - Microsoft

+ 引擎调用 API

+ 采样 - 光栅化

+ VBO 数据：位置坐标，法向量，RGB，纹理坐标

+ 计算机图形学

  + 生成图形
  + 处理图形
  + 显示图形

### 疑问

+ **fragment 和 pixel 是同一个概念吗？**

  之前在学习的时候对 fragment 只有一个大概的认识，可以理解为对顶点构成的图元的采样，但是不清楚采样的粒度是否是像素大小，后来在教程上看到这么一句话：

  > OpenGL 中的一个片段是 OpenGL 渲染一个像素所需的所有数据。
  >
  > 片段着色器的主要目的是计算一个像素的最终颜色。

  确实，片段的大小是像素级别的。

+ **为什么 OpenGL 主要处理三角形？**

  上课的时候经常听到老师说物体表面的**顶点**，当时就在想为什么不直接说物体表面的**点**，后来在教程上看到说：

  > OpenGL 主要处理三角形。

  的确，如果物体表面是由一个个小三角形构成的，说是顶点就合情合理了，但是为什么 OpenGL 主要处理三角形呢，我就去 reference 上查到了 `glDrawArrays` 的函数原型：

  ```c++
  void glDrawArrays(GLenum mode, GLint first, GLsizei count);
  ```

  其中第一个参数 `mode` 用来指定要绘制的图元类型，可取的值主要有 `GL_POINTS`, `GL_LINES`, `GL_TRIANGLES` 等等，但是没有看到矩形，我就在想为什么 `glDrawArrays` 不能直接绘制矩形呢，确实可以通过绘制两个三角形再拼接的方式间接地造出一个矩形，甚至还提供了 EBO 的方法来减少顶点个数，但是直接提供一个绘制矩形的方法不是更方便吗。

  后来我想到老师有说过为什么三角形稳定，因为只有三个顶点的时候能保证它们是**共面**的，我一下就明白了，我之前一直假设用来绘制矩形的四个顶点是共面的，所以意识不到它的麻烦之处，但是如果它们不共面的话，在片段着色器中进行纹理采样，颜色插值甚至用法向量计算光照都将成为很麻烦的问题，比如在 VBO 中指定法向量时，四个不共面的顶点中任意一点理论上都可以属于三个面，那法向量该如何指定就十分麻烦了。

  所以，在可以使用 EBO 的情况下，通过指定四个顶点直接绘制矩形显得没有必要，因为后者唯一的优势即减少顶点个数对于 EBO 来说也十分容易做到，但是非平面的复杂性以及对设计理念的违背是十分令人讨厌的。

## 第 2 章  光栅化技术

### 2-1 基本图元绘制算法

+ 图形的表示：线框模型、表面模型、实体模型
+ 图形的显示：窗口（window）和视区（viewport）的区别
+ 帧缓冲存储器：24 个位平面 - 全彩色；32 个位平面 - 真彩色（存储 α 值，像素点的不透明度）
+ 绘制基本图元：在 `glBegin()` 指定要绘制的图元类型，根据与 `glEnd()` 之间的顶点顺序进行绘制。
+ 光栅化（扫描线算法）：将基本图元的几何定义转化为图像空间中的像素点的集合（片段）
+ 点的光栅化：直接取整、四舍五入
+ 直线的光栅化：直线方程、DDA 算法、Bresenham 算法
+ 圆的光栅化：Bresenham 算法、中点画圆算法

### 2-2 多边形颜色填充与可见面判别

+ 多边形填充算法：内部检查法、奇偶扫描转换算法、有序边表多边形扫描转换算法、边填充算法、边标志算法、种子填充法、泛滥填充算法、渐变填充算法

+ 可见面判别算法：分为物空间算法和像空间算法

  画家算法、后相面判别算法（面剔除）、深度缓冲器算法（z-buffer）

### 2-3 反走样技术

+ 走样（aliasing）：由于低频采样（采样不充分）而造成的信息失真称为走样

  只要有像素存在，必然存在走样。

+ Nyquist 采样定理：为了能从采样信号中正确重建原始信号，采样频率必须大于或等于原始信号最大频率的**两倍**。

+ 滤波：箱式滤波、三角滤波、正弦滤波。

  滤波器的面积始终为 1。

+ 简单区域采样：像素的亮度与其落在直线条内的面积成正比

+ 全屏反走样技术（FSAA）：通过密集采样和滤波减少锯齿效应，主要针对 3D 场景绘制

+ 顺序栅格超采样（OGSS），旋转栅格超采样（RGSS）：采样点的位置旋转了一个角度来达成更好的消除锯齿目的。

+ 多级采样技术（MSAA）：超采样的优化，与相邻像素关联，选择边缘像素进行处理

+ 现有问题：性能下降，近 45 度和 135 度的边界走样。

+ 纹理放大滤波、纹理缩小滤波

+ OpenGL 反走样步骤：激活反走样 -> 激活融合操作 -> 选择反走样控制方式

+ 调用 `glHint()` 函数指定反走样执行方式：

  ```c++
  void glHint(GLenum target, GLenum hint);
  ```


### 疑问

+ **窗口和视口的区别是什么？**

  视口是与设备相关的一个矩形区域，坐标单位是与设备相关的。窗口的坐标是逻辑坐标，与设备无关。

  为了体会窗口坐标与视口坐标的转换，先用 `SetwindowtOrg(100, -300)` 将视口移到 (100,-300)，这相当于把逻辑点 (100,-300) 映射到设备点 (0,0）。

  进行画图时，它的转换过程如下： 
  窗口与视口坐标转换，由于窗口坐标 (100,-300) 映射为设备坐标 (0,0)，所以窗口 (100,-600) 映射为视口(0,-300)，窗口 (100,-800) 视映射为视口 (0,-500) 。

  程序作图时，使用的坐标总是是窗口坐标。

## 第 3 章  建模与动画

### 3-1 三维建模

+ 三维模型要素：顶点、边、面、环、体
+ 建模方法：离散表示、边界表示、空间分区
+ 点云模型
+ 表面多边形法 B-rep
+ 曲面建模方法（一般曲面、二次曲面、超二次曲面）
+ 可变形柔性物体
+ 扫描表示：通过平移、旋转及其他对称变换来构造三维模型
+ 结构实体几何法 CSG
+ 八叉树：四叉树的三维扩展
+ BSP 树
+ 分形几何
+ 粒子系统模型表示

### 3-2 多边形技术

+ 高效细化：三角形化、三角剖分

+ 着色问题：为便于渲染着色，通常将四边形分割为三角形，不同的分割方法会得到不同的渲染效果

+ 曲面多边形化

+ 自适应细化：根据某种度量标准（曲率、三角形 边长或者屏幕大小等）来调整细化率

+ 分数细化：面向三角片的非整型细化

+ T型顶点与边缘裂缝

+ 合并：

  **1.** 形成所有多边形的边－面结构，并排序；

  **2.** 找到相连的多边形组；确定体特性，寻找边界边；

  **3.** 对每组边－面进行必要的翻转来获得一致性

  **4.** 确定网格内部方向，根据需要翻转相应表面

  **5.** 找出折叠边界

  **6.** 生成多边形网格 Mesh

+ 条带化：条带化是将三角形网格转换成多组多边形条带的过程。

+ 网格简化：网格简化是在视图保持图形外观不变的情况下尽可能减少精细模型的多边形数目

+ LOD 模型：Level of Details 距离视点更远的模型用更少三角形的网格模型来表示

+ 网格简化：

  + 顶点聚合
  + 顶点移除
  + 边塌陷
  + 三角形塌陷

+ ROAM 分层结构简化算法：将分层结构用于地形数据，然后对分层结构进行计算，最后只绘制足以表示地形的那层数据。

## 第 4 章 光照与着色

### 4-1 基础光照计算

+ 光照明模型：图形对象上某点处的光强度的物理描述。
+ 面的明暗处理：通过光照模型中的光强计算，确定场景中物体表面的所有投影像素点的光强，也称为面绘制。
+ 环境光：在基本光照模型中，为场景设置的一个基准光亮度，用以简单模拟一种从不同物体表面所产生的反射光的统一照明，称为环境光(ambient light)或背景光
+ 漫反射光：光源照射到物体表面产生的漫反射
+ 镜面反射：光照下的光滑物体表面会在某个观察方向上产生高光，这种现象称为镜面反射。
+ 颜色：用RGB各分量表示光源强度和物体表面颜色，并根据光照模型计算反射光线中的RGB分量。
+ 透明度：通常为计算简便，只用一个0到1之间的折射系数kt标识有多少背景光线被透射
+ Flat Shading：也称恒定光强度明暗处理，快捷高效，一个多边形上的点均用相同的光强度进行绘制
+ Gouraud Shading：在表面上将光强值进行双线性插值来绘制表面多边形，每个多边形的强度值沿公共边与相邻多边形的光强值相接，消除了平面绘制中的光强不连续的现象。
+ Phong Shading：比Gouraud明暗处理更精确的面绘制算法，真实地表现高光并大大降低马赫带效应。
+ 光线跟踪算法：场景中各个表面所发出的光向四周散射，场景中有无数的光线，但只有少量穿过投影平面，被观察者的视点接收。因此，若反向跟踪一条由某像素出发射向场景的光线，并通过累计可得到该像素的光强度值

### 4-2 高级着色之 BRDF

+ BRDF 光照模型：BRDF描述了入射辐射亮度和发射辐射亮度是如何相互联系的，但没有解释材料是如何在物理上与光相互作用的。理解BRDF的一种方法为把入射方向保持恒定，然后观察其输出结果。交点附近的球面部分为漫反射项。椭圆形部分的为反射叶(reflectance lobe)（镜面项），通常在入射光的反射方向。

+ 给定一BRDF和入射辐射亮度分布，反射方程决定了表面在给定视域方向的反射辐射亮度。它通过在表面的半球面上对所有方向的入射辐射亮度进行积分得到

+ 测量方法

  + 通过测量设备获取真实材料表面的BRDF，可采用：角度测定法 (goniometers)
  + 双向反射计成像法 (imaging bidrectional reflectometers)
  + BRDF Theoretic Models

+ 不同BRDF理论模型对比：使用 Half vector lobe 好于 mirror lobe，Cook-Torrance 和 Ashikhmin 模型表面绘制的模拟效果最好

+ 微面元Microfacet：因为高斯分布在数学上处理起来较容易，在这些BRDF模型中，微面元通常假设在大小和角度上具有高斯分布。镜面反射可以用一些微面元的直接反射来描述，而漫反射可以用微面元间的相互反射来描述。微面元之间还可以互相投射阴影。当微面元的大小与光的波长相近时，还有一个重要概念height correlation, 可用来模拟干涉、衍射等物理现象。

+ 菲涅尔反射Fresnel Reflectance：菲涅尔反射对于塑料、玻璃和水等绝缘体或电介质材料非常重要。当电介质材料以接近掠角(Grazing angle)的角度观察时，反射会更厉害（但对于金属，该角度引起的反射变化相对较小）。当用最浅的掠角时，所有的材料变成全反射

+ BSSRDF：Bidirectional Surface Scattering Reflectance Distribution Function 双向表面散射反射率分布函数

  BRDF是 BSSRDF的一种逼近，考虑具有内部散射的半透明材质

+ 散射光 廷德尔散射

  颗粒浑浊媒质的散射，散射光的强度和入射光的波长的关系不明显，散射光的波长和入射光的波长相同。（例如牛奶）

+ BSSRDF通过把入射光的位置和发射光的位置作为函数的输入覆盖了散射现象。它描述的是光从入射方向在表面的某一点入射，然后在另一点沿发射方向发射的比率。

+ 应用BRDF的直接方法计算顶点的颜色并把结果传到流水线

  但其缺点是：如果BRDF反射在一些像素上的变化速度太快，线性插值会导致丢失或过分突出这种反射变化

+ 入射纹理中每个纹素的uv坐标表示入射方向，反射纹理中每个纹素的uv坐标表示反射方向。例如，u坐标可以映射到方位角，v坐标可以映射到仰角。

## 第 5 章 光影与纹理细节

+ 光影效果：反射（倒影），折射，阴影，大幅度提高图形绘制的真实感，由视点作为提示信息来确定空间位置关系 。
+ 平面反射，反射变换矩阵，如果P点在原点，其法矢量N为(0,1,0)，则平面反射就可以看作相对于X轴对称做的一个复制；为得到倒影的正确光照，要计算复制模型在相应位置和方向上的光照效果；可以用缩放矩阵S(1,-1,1)来计算；
+ 曲面反射：用光线跟踪的方法计算，也可用环境纹理映射的方法
+ 硬阴影，阴影的绘制：先绘制阴影投射平面
  关闭深度缓冲器，对投影多边形进行绘制（由于没有深度比较，因此可保证绘制的阴影总是在投射平面上）；
  打开深度缓冲器，绘制剩余的几何体。
  （1）用一个模板缓冲器，避免阴影绘制到投射平面之外
  （2）动画场景中，对每一帧计算阴影的消耗太大，可将相对静止的阴影作为纹理进行绘制。
+ 软阴影，只要光源有一定面积，就会产生软阴影，可采用多种技术将硬阴影转化为软阴影；
  主要思想：对面光源或体光源上的点进行采样；将每一个采样点看作一个点光源，生成遮挡物在接收面上的阴影图像；将所有采样点对应的阴影图像在累加缓冲器中进行平均，产生最终的软阴影的纹理。
+ 纹理映射方法：
  + 纹理坐标系(s,t)
  + 物体表面的表示在(u,v)坐标系
  + 投影平面上的像素显示在(x,y)笛卡儿坐标系
  + 两种映射方法：
    将纹理模式映射至物体表面，然后再进行投影变换映射至投影平面，称为纹理扫描
    将投影平面的像素区域映射至物体表面，再映射至纹理空间，称为像素次序扫描
+ 环境映射：
  + Environment Mapping，将空间光照模型作为纹理映射到物体表面
  + 首先定义一个描述单个或一组物体周围环境的光强度数组（即环境纹理，包括光源强度、天空和其他背景物体），将环境纹理映射到一个封闭环境中表面；
  + 然后根据观察方向将环境空间表面的环境纹理映射至物体表面，实现全局镜面反射和漫反射效果；
  + 环境映射的封闭空间可以是球体，更经常使用立方体或圆柱体形状的封闭空间。
+ 凹凸函数b(u,v)的定义：
  + 根据Height Map计算Normal
  + 设当前像素纹理坐标为(u, v)，切线空间中切向量为T（对应纹理空间U方向），副法线为B（对应纹理空间V方向），Height(u, v)表示纹理坐标(u, v)处的高度值
  + 所有计算均是在切线空间
+ 法线贴图：
  + Normal Mapping
  + 根据高分辨率模型(Reference Model)顶点的法矢量来对低分辨率的模型(Working Model)进行纹理映射，可在简单模型上获得复杂的纹理细节和光照效果
  + 只改变光照,不改变模型
+ 视差贴图：
  + 视点观察到的是模型面片上的T位置
  + T点在高度图中读到的偏移是A，但实际视点看到的应该是B,要估算在纹理图中A->B的偏移量
  + 特别是在掠角Grazing Angle方向
+ 气态过程纹理：
  + 用体密度函数在三维纹理空间建立气体的隐式描述；
  + 用湍流函数进行扰动，计算扰动后每点的密度值；

## 第 6 章 图形特效

+ Frame Buffer

  + 颜色缓存 Color Buffer
  + 深度缓存 Depth Buffer
  + 模板缓存 Stencil Buffer
  + 累加缓存 Accumulate Buffer

+ 存储像素的RGBA颜色数据：双缓存和单缓存
  glutInitDisplayMode(GLUT_DOUBLE|GLUT_RGB);
  glutInitDisplayMode(GLUT_SINGLE|GLUT_RGB);
  调用glGetBooleanv(GL_DOUBLE_BUFFER)查询系统是否支持双缓存；
  单缓存系统只有前缓存；双缓存可用于动画的实现。

+ 模板缓存：

  + 把绘制操作限制在屏幕上的某个区域
  + 每个像素对应一个无符号整数值
  + 这个值的具体意义视程序的需求而定
  + 如同在屏幕上覆盖了一个有图案的模板，然后将颜色喷涂到模板上
  + 模板上的图案被保留在屏幕上，图案以外的区域则没有喷涂图像
  + 倒影、阴影的生成

+ 累加缓存：

  + 存储RGBA颜色数据
  + 把一系列图像累加起来合成图像
  + A-buffer可见面判别、模拟场景反走样、运动模糊、仿真照片景深、计算多光源阴影
  + OpenGL不直接向累加缓存中写数据，而是在颜色缓存中生成图像再写入累加缓存
  + 累加结束后，再把结果拷贝到颜色缓存中进行显示
  + 比颜色缓存使用更多的数位来表示颜色，减少舍入误差，得到高质量的图像

+ 累加缓存实现运动模糊：

  算法思想：把n次渲染的物体在不同位置的画面进行按比例在累加缓存中进行叠加，然后输出到颜色缓存进行显示

  + 清空累加缓存
  + 由于不断的累加颜色，会导致颜色溢出，整个屏幕变白，所以需要在每次累加之后进行适当的缩放
  + n取值要适当，太大则模糊叠影会消失的很慢；太小则运动模糊效果不明显
  + 如果只需要部分物体实现运动模糊效果，累加渲染时只渲染要模糊的部分

+ 基于层的景深模糊实现：

  + 主要思想是将图像根据深度信息分到若干层，在每层进行不同程度的模糊，最后合成在一起
  + 通过把场景绘制到一个纹理并把每个物体的模糊量(根据距离)存贮到alpha通道，Vertex Shader和Pixel Shader可以用来实现景深效果。
  + 采用图像处理技术对该纹理模糊两次，总共得到三个纹理。对于每个像素，Pixel Shader获取Alpha通道中的模糊因子并在三个纹理间插值，便可得到模糊效果。

+ 三维融合步骤：

  + 激活深度检测；
  + 绘制所有不透明物体；
  + 设置深度缓存为只读glDepthMask(GL_FALSE)；
  + 绘制所有半透明物体；
  + 恢复深度缓存为读/写glDepthMask(GL_TRUE)；

+ 渐隐效果：

  + 将一幅图像逐渐的用另一幅图像替换掉
  + Direct3D的多纹理融合技术
  + 也可以使用Stencil Buffer

+ 公告板技术Billboard：

  + 通过定义一个固定的矩形并对它使用纹理来创建和渲染公告板
  + 这个矩形图元随着观察者不断旋转，使它总能朝向观察者
  + 在矩形上贴纹理
  + 公告板某些局部可以是透明的
  + 通过纹理动画实现火焰、闪光和爆炸效果

+ 细节纹理特效：

  + 在表面上产生磨损的痕迹、凹凸的表面以及其他一些表面细节
  + 观察者远离图元不需要很多细节
  + 应用mipmap
  + 细节纹理还可用作深度提示（depth cue）
  + 如果对观察着逐渐接近的表面使用细节纹理，将会使其得知自己正在接近

+ 焦散 Caustic：

  + 焦散是一种间接照明效果
  + 间接照明光线（即光子）从光源发射出来后，先经过一次（或多次） Specular 表面反、折射作用，再投射到某个Diffuse表面上，最后以Diffuse的形式被摄影机记录 
  + 此过程中的Specular表面被称为焦散投射物体 ，Diffuse表面称为焦散接收物体

